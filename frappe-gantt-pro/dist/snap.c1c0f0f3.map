{"version":3,"sources":["src/snap.js"],"names":["passport","require","connect","muddle","store","mongo","MongoClient","e","DAYS_MS","defaultOpts","sessionDuration","connectionString","collection","cb","opts","err","db","module","exports","snap","pipeline","params","Error","secret","withDefaults","console","log","bounce","call","use","cookieParser","session","cookie","sessionCookie","maxAge","initialize","process","nextTick","Object","keys","forEach","opt","hasOwnProperty","thunk","fn"],"mappings":"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","file":"snap.c1c0f0f3.map","sourceRoot":"..","sourcesContent":["var passport = require('passport')\nvar connect = require('connect')\nvar muddle = require('muddle')\nvar store\nvar mongo\ntry {\n  store = require('connect-mongo')(connect)\n  mongo = require('mongodb').MongoClient\n} catch (e) {}\n\nvar DAYS_MS = 24*60*60*1000\nvar defaultOpts = {\n  sessionDuration: 30 * DAYS_MS,\n  connectionString: 'mongodb://localhost:27017/',\n  collection: 'snapSessions',\n  store: (!store || !mongo) ? false : function (cb) {\n    var opts = this\n    mongo.connect(opts.connectionString, function (err, db) {\n      if (err) return cb(err)\n      try {\n        store = new store({db: db, collection: opts.collection})\n        cb(null, store)\n      } catch (e) {\n        cb(e)\n      }\n    })\n  }\n}\n\n// @param pipeline - an object with a `.use` method which takes a connect-style middleware function\n// @param params - an object with properties as parameters (see)\n// @returns void\nmodule.exports = function snap(pipeline, params, cb) {\n  if (typeof params !== 'object') throw new Error('Missing required parameter: params must be an object')\n  if (!params.secret) throw new Error('Missing required parameter: secret')\n  withDefaults(params)\nconsole.log(params)\n  if (!params.store || !params.connectionString) throw new Error('Session Store not available. Provide your own with the `store` parameter or run `$ npm install`.')\n\n  bounce.call(params, params.store, function (err, store) {\n    if (err) {\n      if (cb) { cb(err) } else { throw err }\n    }\n\n    pipeline.use(muddle(\n      connect.cookieParser(),\n      connect.session({secret: params.secret, store: store, cookie: params.sessionCookie || {maxAge: params.sessionDuration}}),\n      passport.initialize(),\n      passport.session()\n    ))\n    process.nextTick(function () { cb() })\n  })\n}\n\nfunction withDefaults(params) {\n  Object.keys(defaultOpts).forEach(function (opt) {\n    if (!params.hasOwnProperty(opt)) {\n      params[opt] = defaultOpts[opt]\n    }\n  })\n}\n\nfunction bounce(thunk, fn) {\n  if (typeof thunk === 'function') {\n    thunk.call(this, fn)\n  } else {\n    fn.call(this, fn)\n  }\n}"]}